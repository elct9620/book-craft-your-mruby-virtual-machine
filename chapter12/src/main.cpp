#ifndef UNIT_TEST
#include <Arduino.h>

#include<mvm.h>

#include <stdint.h>
#if defined __GNUC__
__attribute__((aligned(4)))
#elif defined _MSC_VER
__declspec(align(4))
#endif

const uint8_t bin[] = {
  // cputs
  0x52,0x49,0x54,0x45,0x30,0x30,0x30,0x37,0xf9,0x53,0x00,0x00,0x00,0x51,0x4d,0x41,
  0x54,0x5a,0x30,0x30,0x30,0x30,0x49,0x52,0x45,0x50,0x00,0x00,0x00,0x33,0x30,0x30,
  0x30,0x32,0x00,0x00,0x00,0x46,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x09,
  0x10,0x01,0x2e,0x01,0x00,0x00,0x37,0x01,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x01,0x00,0x05,0x63,0x70,0x75,0x74,0x73,0x00,0x45,0x4e,0x44,0x00,0x00,0x00,0x00,
  0x08,
};

mrb_value c_puts() {
  printf("Hello World from C\n");

  return mrb_nil_value();
}

static struct kh_mt_s *mvm_methods;
void setup() {
  Serial.begin(9600);

  mvm_methods = kh_init(mt);
  mrb_define_method("cputs", c_puts, mvm_methods);
}

void loop() {
  mrb_exec(bin + 34, mvm_methods);
  delay(5000);
}
#endif
