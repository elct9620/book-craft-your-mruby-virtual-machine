#include<string.h>
#include<opcode.h>
#include "test_irep.h"

#include<stdio.h>

void test_irep_read_header() {
  const uint8_t bin[] = {
    0x00, 0x00, 0x01, 0x00, // Size = 255
    0x00, 0x04, // nlocals = 4
    0x00, 0x03, // nregs = 3
    0x00, 0x01, // nirep = 1
  };

  uint8_t len;

  irep_header* header = irep_read_header(bin, &len);

  TEST_ASSERT_EQUAL_UINT32(256, header->size);
  TEST_ASSERT_EQUAL_UINT16(4, header->nlocals);
  TEST_ASSERT_EQUAL_UINT16(3, header->nregs);
  TEST_ASSERT_EQUAL_UINT16(1, header->nirep);

  TEST_ASSERT_EQUAL(10, len);

  free(header);
}

void test_irep_get_literal() {
  const uint8_t bin[] = {
    // "hello world"
    0x52,0x49,0x54,0x45,0x30,0x30,0x30,0x37,0xc9,0x1a,0x00,0x00,0x00,0x54,0x4d,0x41,
    0x54,0x5a,0x30,0x30,0x30,0x30,0x49,0x52,0x45,0x50,0x00,0x00,0x00,0x36,0x30,0x30,
    0x30,0x32,0x00,0x00,0x00,0x40,0x00,0x01,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x06,
    0x4f,0x01,0x00,0x37,0x01,0x67,0x00,0x00,0x00,0x01,0x00,0x00,0x0b,0x68,0x65,0x6c,
    0x6c,0x6f,0x20,0x77,0x6f,0x72,0x6c,0x64,0x00,0x00,0x00,0x00,0x45,0x4e,0x44,0x00,
    0x00,0x00,0x00,0x08,
  };

  const uint8_t* p = irep_get(bin + 34, IREP_TYPE_LITERAL, 0);
  int type = READ_B();
  uint16_t size = READ_S();

  char res[size + 1];
  memcpy(res, p, size + 1);

  TEST_ASSERT_EQUAL_STRING("hello world", res);
}

void test_irep_get_symbol() {
  const uint8_t bin[] = {
    // :name
    0x52,0x49,0x54,0x45,0x30,0x30,0x30,0x37,0xa3,0x03,0x00,0x00,0x00,0x4d,0x4d,0x41,
    0x54,0x5a,0x30,0x30,0x30,0x30,0x49,0x52,0x45,0x50,0x00,0x00,0x00,0x2f,0x30,0x30,
    0x30,0x32,0x00,0x00,0x00,0x39,0x00,0x01,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x06,
    0x0e,0x01,0x00,0x37,0x01,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x04,
    0x6e,0x61,0x6d,0x65,0x00,0x45,0x4e,0x44,0x00,0x00,0x00,0x00,0x08,
  };

  const uint8_t* p = irep_get(bin + 34, IREP_TYPE_SYMBOL, 0);
  uint16_t size = READ_S();

  char res[size + 1];
  memcpy(res, p, size + 1);

  TEST_ASSERT_EQUAL_STRING("name", res);
}
